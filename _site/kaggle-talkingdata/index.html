<!DOCTYPE html>
<html>
  <head>
    
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <link rel="shortcut icon" href="/static/img/favicon.ico" />
        <title>Kaggle - TalkingData - Marco Tompitak</title>
        <meta name="author" content="Marco Tompitak" />
        <meta name="description" content="Kaggle - TalkingData" />
        <meta name="keywords" content="Kaggle - TalkingData, Marco Tompitak, data-science kaggle" />

        <meta content="0" property="fb:app_id">
        <meta content="Marco Tompitak" property="og:site_name">
        
          <meta content="Kaggle - TalkingData" property="og:title">
        
        
          <meta content="article" property="og:type">
        
        
          <meta content="My GitHub Page" property="og:description">
        
        
          <meta content="http://localhost:4000/kaggle-talkingdata/" property="og:url">
        
        
          <meta content="2017-07-21T02:00:00+02:00" property="article:published_time">
          <meta content="http://localhost:4000/about/" property="article:author">
        
        
          <meta content="http://localhost:4000/static/img/logo-high-resolution.png" property="og:image">
        
        
          
          <meta content="data-science kaggle" property="article:section">
          
        
        
        <meta name="twitter:card" content="summary">
        <meta name="twitter:site" content="@\#">
        <meta name="twitter:creator" content="@\#">
        
          <meta name="twitter:title" content="Kaggle - TalkingData">
        
        
          <meta name="twitter:url" content="http://localhost:4000/kaggle-talkingdata/">
        
        
          <meta name="twitter:description" content="My GitHub Page">
        
        

      <link rel="alternate" type="application/rss+xml" title="RSS" href="/feed.xml">
      <script type="text/javascript">window.baseurl = 'http://localhost:4000';</script>
      
        <!-- Custom Fonts -->
        <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Roboto:300,400,500,700" type="text/css">

        <!-- FontAwesome icons -->
        <link rel="stylesheet" href="https://use.fontawesome.com/74dfc6cf47.css">

        <!-- Core BootStrap CSS -->
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
        <!-- Material Design CSS -->
        <link rel="stylesheet" href="/static/css/bootstrap-material-design.min.css">

        <!-- syntax highlighting CSS -->
        <link rel="stylesheet" href="/static/css/syntax.css">

        <!-- Custom CSS -->        
        <link rel="stylesheet" href="/static/css/thickbox.css">
        <link rel="stylesheet" href="/static/css/main.css">
        <link rel="stylesheet" href="/static/css/projects.css">

        <script type="text/javascript">
          //loadingImage is relative to project dir
          var tb_pathToImage = "/static/img/loadingAnimation.gif";
        </script>

  </head>

  <body class="home overflow-hidden">
    <div class="header-panel shadow-z-2">
      <div class="container">
        <div class="row">
          <div class="col-md-3 col-sm-4 col-xs-12">
            <div class="row-picture">
              <img id="about" class="logo-img" src="/static/img/avatar.svg" height="75px" width="75px">
            </div>
            <div class="row-details">
              <h4 class="list-group-item-heading">Marco Tompitak</h4>
              <p class="list-group-item-text">Biophysicist</p>
              <div class="social-icons">
	
        <a class="icon" target="_blank" href="https://github.com/marcotompitak"><i class="fa fa-github"></i></a>
    
        <a class="icon" target="_blank" href="https://www.linkedin.com/in/marcotompitak/"><i class="fa fa-linkedin"></i></a>
    
        <a class="icon" target="_blank" href="https://stackexchange.com/users/2808839/marco-tompitak"><i class="fa fa-stack-exchange"></i></a>
    
        <a class="icon" target="_blank" href="http://www.rapiddiffusion.com/"><i class="fa fa-pencil-square-o"></i></a>
    
</div>

            </div>
            <div class="navbar-header pull-right">
              <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
                <span class="sr-only">Toggle navigation</span>
                <i class="fa fa-2x fa-bars"></i>
              </button>
            </div>
          </div>
          <div class="col-md-9 col-sm-8 col-xs-12">
          <div class="row">
            <h2 class="blog-title-pro ">Kaggle - TalkingData</h2>
            
            </div>
            <p class="info">
              
                <span class="time">21 Jul 2017</span>
              
              
                <span class="categories">
                  &raquo; 
                  
                    <a href="/category/data-science kaggle">data-science kaggle</a>
                    
                  
                </span>
              
            </p>
          </div>
        </div>
      </div>
    </div>

    <div class="container main outer">
      <div class="row">
        <div class="col-md-3 col-xs-12">
              <nav class="menu">
    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
    <ul class="list-separator nav navbar-nav well well-primary page">

	
	
	
	
	
	
    
	
	<li class="col-lg-12 col-md-12 col-sm-4 col-xs-12  kaggle-talkingdata"><a href="/" target="_self"><i class="fa fa-home"></i> Home</a></li>

	
	
	
	
	
	
    
	
	<li class="col-lg-12 col-md-12 col-sm-4 col-xs-12  kaggle-talkingdata"><a href="/about/" target="_self"><i class="fa fa-user"></i> About</a></li>

	
	
	
	
	
	
    
	
	<li class="col-lg-12 col-md-12 col-sm-4 col-xs-12  kaggle-talkingdata"><a href="/projects" target="_self"><i class="fa fa-desktop"></i> Projects</a></li>

	
	
	
	
	
	
    
	
	<li class="col-lg-12 col-md-12 col-sm-4 col-xs-12  kaggle-talkingdata"><a href="/publications" target="_self"><i class="fa fa-file-text-o"></i> Publications</a></li>

	
	
	
	
	
	
    
	
	<li class="col-lg-12 col-md-12 col-sm-4 col-xs-12  kaggle-talkingdata"><a href="https://github.com/marcotompitak" target="_self"><i class="fa fa-github"></i> Github</a></li>

</ul>

    </div>
    </nav>

        </div>
        <div class="col-md-9 col-xs-12 full">
          <script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>
<script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type="text/javascript"></script>

<div class="well" style="text-align:justify">
    
    <div>
    	<h2 id="kaggle-competition-classify-mobile-users">Kaggle Competition: Classify Mobile Users</h2>

<p><em>(This is a static version of an iPython notebook. The actual notebook can be found on <a href="https://github.com/marcotompitak/kaggle-code/tree/master/TalkingData">GitHub</a>.)</em></p>

<p>This is an analysis for the <a href="https://www.kaggle.com/c/talkingdata-mobile-user-demographics">TalkingData Mobile User Demographics</a> Kaggle competition. The competition was already closed when I started this, but I went through it for practice. I got a score of 2.29, which, if I had been able to join the leaderboard, would have been at position 1028 out of 1689; a decent enough score for a simple approach.</p>

<p>From the discussion board of the competition, it seems like many people used <code class="highlighter-rouge">xgboost</code> for this challenge, but I’ve done a competition with <code class="highlighter-rouge">xgboost</code> <a href="/kaggle-zillow/">before</a>, so I’ll try something else: logistic regression. This was not so trivial, because I quickly ran out of memory to store my one-hot encoded features. Full credit goes to the person who made <a href="https://www.kaggle.com/dvasyukova/a-linear-model-on-apps-and-labels">this beautiful kernel</a> available for teaching me how to get around that.</p>

<p>The challenge is to classify the users of mobile devices into several age categories, and also into whether they are male or female. The data on which to base the classification consists of the type of phone they have and what apps they use. Some additional information is available, but I’ll focus on those pieces of information.</p>

<p>The apps someone uses probably says a lot about who they are: do they play a lot of games on their phone or not, for instance? That’s why I’ll start with the apps.</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">pandas</span> <span class="kn">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">LabelEncoder</span>
<span class="kn">from</span> <span class="nn">scipy.sparse</span> <span class="kn">import</span> <span class="n">csr_matrix</span><span class="p">,</span> <span class="n">hstack</span>
<span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">LogisticRegression</span><span class="p">,</span> <span class="n">LogisticRegressionCV</span>
</code></pre>
</div>

<h1 id="classifying-based-on-apps-installed">Classifying based on apps installed</h1>

<p>The data in <code class="highlighter-rouge">events.csv</code> gives us a list of events happening on different devices. The file <code class="highlighter-rouge">app_events</code> tells us what this event means: the ID of the corresponding app, and whether at that event the app is installed and active. The <code class="highlighter-rouge">is_installed</code> column is always 1, so if an app is present in this list, it is installed on the device.</p>

<p>Let’s use this to build our first set of features: the apps that a device has installed. We’ll load up the data and merge the two datafiles into the format we want to use.</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="c"># Load files; only the columns we care about</span>
<span class="n">events</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s">'input/events.csv'</span><span class="p">,</span> <span class="n">usecols</span> <span class="o">=</span> <span class="p">[</span><span class="s">'event_id'</span><span class="p">,</span> <span class="s">'device_id'</span><span class="p">])</span>
<span class="n">app_events</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s">'input/app_events.csv'</span><span class="p">,</span> <span class="n">usecols</span> <span class="o">=</span> <span class="p">[</span><span class="s">'event_id'</span><span class="p">,</span> <span class="s">'app_id'</span><span class="p">])</span>


<span class="n">device_apps</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">app_events</span>
    
     <span class="c"># Merge on event_id</span>
    <span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">events</span><span class="p">,</span> <span class="n">how</span> <span class="o">=</span> <span class="s">'left'</span><span class="p">,</span> <span class="n">left_on</span> <span class="o">=</span> <span class="s">'event_id'</span><span class="p">,</span> <span class="n">right_on</span> <span class="o">=</span> <span class="s">'event_id'</span><span class="p">)</span>
    
     <span class="c"># event_id itself is not interesting</span>
    <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s">'event_id'</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
    
     <span class="c"># Because the events correspond to more than just</span>
     <span class="c"># being installed, there are many duplicates</span>
    <span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>
<span class="p">)</span>

<span class="c"># Our data now looks like this</span>
<span class="n">device_apps</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</code></pre>
</div>

<div>
<style>
    .dataframe thead tr:only-child th {
        text-align: right;
    }

    .dataframe thead th {
        text-align: left;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>app_id</th>
      <th>device_id</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>5927333115845830913</td>
      <td>-6401643145415154744</td>
    </tr>
    <tr>
      <th>1</th>
      <td>-5720078949152207372</td>
      <td>-6401643145415154744</td>
    </tr>
    <tr>
      <th>2</th>
      <td>-1633887856876571208</td>
      <td>-6401643145415154744</td>
    </tr>
    <tr>
      <th>3</th>
      <td>-653184325010919369</td>
      <td>-6401643145415154744</td>
    </tr>
    <tr>
      <th>4</th>
      <td>8693964245073640147</td>
      <td>-6401643145415154744</td>
    </tr>
  </tbody>
</table>
</div>

<p>In order to perform logistic regression, we need to one-hot encode our apps. Unfortunately there are just too many of them:</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="c"># Too many apps. </span>
<span class="n">device_apps</span><span class="p">[</span><span class="s">'app_id'</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">size</span>
</code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code>19237
</code></pre>
</div>

<p>A naive call to <code class="highlighter-rouge">pd.get_dummies()</code> quickly results in a memory error. My machine, at least, is not able to deal with creating so many dummies.</p>

<p>However, for any given device, almost certainly only a very small subset of apps is installed. We can therefore encode our dummy variables in a sparse matrix. To do so, we will use <code class="highlighter-rouge">csr_matrix</code> from <code class="highlighter-rouge">scipy</code>, which stores the data in <a href="https://en.wikipedia.org/wiki/Sparse_matrix#Compressed_sparse_row_.28CSR.2C_CRS_or_Yale_format.29">Compressed Sparse Row</a> format. To do so, we need to give it the non-zero values in the matrix (i.e. all the 1s for the apps a given device has installed), and the row and column indices where they are supposed to go.</p>

<p>We want to end up with a matrix whose rows are the devices listed in the <code class="highlighter-rouge">gender_age_train.csv</code> or <code class="highlighter-rouge">gender_age_test.csv</code> files. Therefore we will load up the appropriate file (we’ll start with the training set) and number its rows.</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="c"># Load up the training data</span>
<span class="n">gender_age_train</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s">'input/gender_age_train.csv'</span><span class="p">)</span>

<span class="c"># Numbers its rows in a new column</span>
<span class="n">gender_age_train</span><span class="p">[</span><span class="s">'rownum'</span><span class="p">]</span> <span class="o">=</span> <span class="n">gender_age_train</span><span class="o">.</span><span class="n">index</span>

<span class="c"># We now have this </span>
<span class="n">gender_age_train</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</code></pre>
</div>

<div>
<style>
    .dataframe thead tr:only-child th {
        text-align: right;
    }

    .dataframe thead th {
        text-align: left;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>device_id</th>
      <th>gender</th>
      <th>age</th>
      <th>group</th>
      <th>rownum</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>-8076087639492063270</td>
      <td>M</td>
      <td>35</td>
      <td>M32-38</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>-2897161552818060146</td>
      <td>M</td>
      <td>35</td>
      <td>M32-38</td>
      <td>1</td>
    </tr>
    <tr>
      <th>2</th>
      <td>-8260683887967679142</td>
      <td>M</td>
      <td>35</td>
      <td>M32-38</td>
      <td>2</td>
    </tr>
    <tr>
      <th>3</th>
      <td>-4938849341048082022</td>
      <td>M</td>
      <td>30</td>
      <td>M29-31</td>
      <td>3</td>
    </tr>
    <tr>
      <th>4</th>
      <td>245133531816851882</td>
      <td>M</td>
      <td>30</td>
      <td>M29-31</td>
      <td>4</td>
    </tr>
  </tbody>
</table>
</div>

<p>The columns of our feature matrix should represent the different apps, one column each. To assign consecutive numbers to the apps, we can use <code class="highlighter-rouge">sklearn</code>’s <code class="highlighter-rouge">LabelEncoder</code>:</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="c"># Build numerical labels for our apps</span>
<span class="n">appencoder</span> <span class="o">=</span> <span class="n">LabelEncoder</span><span class="p">()</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">device_apps</span><span class="o">.</span><span class="n">app_id</span><span class="p">)</span>

<span class="c"># Store in a new column</span>
<span class="n">device_apps</span><span class="p">[</span><span class="s">'app'</span><span class="p">]</span> <span class="o">=</span> <span class="n">appencoder</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">device_apps</span><span class="o">.</span><span class="n">app_id</span><span class="p">)</span>

<span class="c"># Combining with our row numbers</span>
<span class="n">sparse_encoding_apps</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">device_apps</span><span class="p">[[</span><span class="s">'device_id'</span><span class="p">,</span> <span class="s">'app'</span><span class="p">]]</span>
    
    <span class="c"># Grab rownum</span>
    <span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">gender_age_train</span><span class="p">[[</span><span class="s">'device_id'</span><span class="p">,</span><span class="s">'rownum'</span><span class="p">]],</span> <span class="n">how</span> <span class="o">=</span> <span class="s">'left'</span><span class="p">,</span> <span class="n">left_on</span> <span class="o">=</span> <span class="s">'device_id'</span><span class="p">,</span> <span class="n">right_on</span> <span class="o">=</span> <span class="s">'device_id'</span><span class="p">)</span>
    
    <span class="c"># Some devices are not in the training set</span>
    <span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
<span class="p">)</span>

<span class="c"># We now have a dataframe encoding all the locations where</span>
<span class="c"># our sparse matrix should have a 1 instead of a 0.</span>
<span class="n">sparse_encoding_apps</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</code></pre>
</div>

<div>
<style>
    .dataframe thead tr:only-child th {
        text-align: right;
    }

    .dataframe thead th {
        text-align: left;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>device_id</th>
      <th>app</th>
      <th>rownum</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>19</th>
      <td>1476664663289716375</td>
      <td>1819</td>
      <td>51154.0</td>
    </tr>
    <tr>
      <th>20</th>
      <td>1476664663289716375</td>
      <td>15784</td>
      <td>51154.0</td>
    </tr>
    <tr>
      <th>21</th>
      <td>1476664663289716375</td>
      <td>15408</td>
      <td>51154.0</td>
    </tr>
    <tr>
      <th>22</th>
      <td>1476664663289716375</td>
      <td>13094</td>
      <td>51154.0</td>
    </tr>
    <tr>
      <th>23</th>
      <td>1476664663289716375</td>
      <td>5733</td>
      <td>51154.0</td>
    </tr>
  </tbody>
</table>
</div>

<p>Using the dataframe we just created, we can now build our sparse matrix. Using <code class="highlighter-rouge">csr_matrix( (data, (row_indices, column_indices) ) )</code>, it builds it as follows.</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="c"># Building our sparse feature matrix</span>
<span class="n">sparse_app_matrix</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">csr_matrix</span><span class="p">(</span>
        <span class="p">(</span>
            <span class="c"># We need as many 1s as there are</span>
            <span class="c"># rows in our training set</span>
            <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">sparse_encoding_apps</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> 
            
            <span class="c"># The rownum and app columns give</span>
            <span class="c"># us the indices at which to place</span>
            <span class="c"># the 1s</span>
            <span class="p">(</span>
                <span class="n">sparse_encoding_apps</span><span class="p">[</span><span class="s">'rownum'</span><span class="p">],</span> 
                <span class="n">sparse_encoding_apps</span><span class="p">[</span><span class="s">'app'</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="p">)</span>
    <span class="p">)</span>
<span class="p">)</span>
</code></pre>
</div>

<p>Our data structure is of course hard to inspect now, but we can look at aggregate quantities. Let’s try to get a feel for what our data looks like.</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="c"># Let's plot the number of apps that each device</span>
<span class="c"># has installed</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="nb">range</span><span class="p">(</span><span class="n">sparse_app_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
    <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">sparse_app_matrix</span><span class="o">.</span><span class="nb">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">flatten</span><span class="p">())[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
    <span class="n">label</span> <span class="o">=</span> <span class="s">'Number of apps per device, sorted'</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span>
    <span class="n">sparse_app_matrix</span><span class="o">.</span><span class="nb">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> 
    <span class="n">color</span> <span class="o">=</span> <span class="s">'black'</span><span class="p">,</span> 
    <span class="n">label</span> <span class="o">=</span> <span class="s">'Average number of apps installed'</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre>
</div>

<p><img src="/pages/ClassifyMobileUsers_files/ClassifyMobileUsers_13_0.png" alt="png" /></p>

<p>In the plot above we see that many devices actually don’t have apps installed, as far as we know. Unfortunately, that will hamper our ability to classify them. Perhaps other parts of the data set will help us with those, but for now we simply take note of this limitation.</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="c"># Let's plot the number of times the apps are</span>
<span class="c"># installed on devices</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="nb">range</span><span class="p">(</span><span class="n">sparse_app_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
    <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">sparse_app_matrix</span><span class="o">.</span><span class="nb">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">flatten</span><span class="p">())[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
    <span class="n">label</span> <span class="o">=</span> <span class="s">'Number of times app is installed, sorted'</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span>
    <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">sparse_app_matrix</span><span class="o">.</span><span class="nb">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">flatten</span><span class="p">())[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> 
    <span class="mi">0</span><span class="p">,</span>
    <span class="mf">0.8</span><span class="p">,</span>
    <span class="n">color</span> <span class="o">=</span> <span class="s">'black'</span><span class="p">,</span>
    <span class="n">label</span> <span class="o">=</span> <span class="s">'To the right of this line, zero installs'</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre>
</div>

<p><img src="/pages/ClassifyMobileUsers_files/ClassifyMobileUsers_15_0.png" alt="png" /></p>

<p>The second plot shows that most apps are not used very much. Some don’t appear at all. This means the features corresponding to these apps will not be very useful. In the case of apps that are not installed on any devices, we might as well throw these features away. However, we will trust regularization to appropriately pick the important features.</p>

<p>Now that we have our sparse feature data, we can fit our logistic regression. Considering that there are features we expect to be useless, we might prefer to do a lasso regression. Unfortunately, scikit-learn doesn’t currently provide support for multinomial lasso regression, and we will use ridge regression instead.</p>

<p>We need to choose the regularization coefficient for our fit, for which we’ll use cross validation.</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="c"># Set up the targets</span>
<span class="n">target</span> <span class="o">=</span> <span class="n">gender_age_train</span><span class="p">[</span><span class="s">'group'</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

<span class="c"># Set up our classifier</span>
<span class="n">logreg_cv</span> <span class="o">=</span> <span class="n">LogisticRegressionCV</span><span class="p">(</span>
    <span class="c"># Values to try for regularization</span>
    <span class="n">Cs</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0001</span><span class="p">,</span> <span class="mf">0.001</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">],</span>
    
    <span class="c"># Lasso not available</span>
    <span class="n">penalty</span> <span class="o">=</span> <span class="s">'l2'</span><span class="p">,</span>        
    
    <span class="c"># We need probabilities</span>
    <span class="n">multi_class</span> <span class="o">=</span> <span class="s">'multinomial'</span><span class="p">,</span> 
    
    <span class="c"># This solver seems to be fastest</span>
    <span class="n">solver</span> <span class="o">=</span> <span class="s">'lbfgs'</span><span class="p">,</span>
    
    <span class="c"># Give it some time</span>
    <span class="n">max_iter</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span>
    
    <span class="c"># CV folds</span>
    <span class="n">cv</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
    
    <span class="c"># Paralellized for 6-core machine</span>
    <span class="n">n_jobs</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span>
    
    <span class="c"># We want the log-loss score</span>
    <span class="n">scoring</span> <span class="o">=</span> <span class="s">'neg_log_loss'</span>
<span class="p">)</span>

<span class="c"># Fit to our data</span>
<span class="n">logreg_cv</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">sparse_app_matrix</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>

<span class="c"># Plot the results</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mf">0.0001</span><span class="p">,</span> <span class="mf">0.001</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">],</span> <span class="o">-</span><span class="n">logreg_cv</span><span class="o">.</span><span class="n">scores_</span><span class="o">.</span><span class="n">popitem</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xscale</span><span class="p">(</span><span class="s">"log"</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre>
</div>

<p><img src="/pages/ClassifyMobileUsers_files/ClassifyMobileUsers_17_0.png" alt="png" /></p>

<p>We see that the optimal value for the regularization is around 0.01, and we’re reaching a score of around 2.37, which is on the lower end of the Kaggle leaderboard. We can look at a finer grid around 0.01 and optimize a bit further, allowing us to dip a little lower.</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="n">logreg_cv</span> <span class="o">=</span> <span class="n">LogisticRegressionCV</span><span class="p">(</span>
    <span class="n">Cs</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.075</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.125</span><span class="p">,</span> <span class="mf">0.15</span><span class="p">,</span> <span class="mf">0.175</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">],</span>
    <span class="n">penalty</span> <span class="o">=</span> <span class="s">'l2'</span><span class="p">,</span> 
    <span class="n">multi_class</span> <span class="o">=</span> <span class="s">'multinomial'</span><span class="p">,</span>
    <span class="n">solver</span> <span class="o">=</span> <span class="s">'lbfgs'</span><span class="p">,</span>
    <span class="n">max_iter</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span>
    <span class="n">cv</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
    <span class="n">n_jobs</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span>
    <span class="n">scoring</span> <span class="o">=</span> <span class="s">'neg_log_loss'</span>
<span class="p">)</span>
<span class="n">logreg_cv</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">sparse_app_matrix</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.075</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.125</span><span class="p">,</span> <span class="mf">0.15</span><span class="p">,</span> <span class="mf">0.175</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">],</span> <span class="o">-</span><span class="n">logreg_cv</span><span class="o">.</span><span class="n">scores_</span><span class="o">.</span><span class="n">popitem</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre>
</div>

<p><img src="/pages/ClassifyMobileUsers_files/ClassifyMobileUsers_19_0.png" alt="png" /></p>

<h1 id="adding-phone-brands-and-models">Adding phone brands and models</h1>

<p>Classifying users based on their apps seems to work quite well, but let’s see if we can improve our score by including another part of the data set. Users in different categories may also prefer different brands and models of phones, so this may add some predictive power. The file <code class="highlighter-rouge">phone_brand_device_model.csv</code> contains for each device the brand and model:</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="n">phones</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s">'input/phone_brand_device_model.csv'</span><span class="p">)</span>
<span class="n">phones</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</code></pre>
</div>

<div>
<style>
    .dataframe thead tr:only-child th {
        text-align: right;
    }

    .dataframe thead th {
        text-align: left;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>device_id</th>
      <th>phone_brand</th>
      <th>device_model</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>-8890648629457979026</td>
      <td>小米</td>
      <td>红米</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1277779817574759137</td>
      <td>小米</td>
      <td>MI 2</td>
    </tr>
    <tr>
      <th>2</th>
      <td>5137427614288105724</td>
      <td>三星</td>
      <td>Galaxy S4</td>
    </tr>
    <tr>
      <th>3</th>
      <td>3669464369358936369</td>
      <td>SUGAR</td>
      <td>时尚手机</td>
    </tr>
    <tr>
      <th>4</th>
      <td>-5019277647504317457</td>
      <td>三星</td>
      <td>Galaxy Note 2</td>
    </tr>
  </tbody>
</table>
</div>

<p>We now want to create a feature matrix just as we did for the apps. We now have two columns, brand and model. The brands may be expected to be a good predictor, so we’ll start with those.</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="c"># Build numerical labels for our brands</span>
<span class="n">brandencoder</span> <span class="o">=</span> <span class="n">LabelEncoder</span><span class="p">()</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">phones</span><span class="p">[</span><span class="s">'phone_brand'</span><span class="p">])</span>

<span class="c"># Store in a new column</span>
<span class="n">phones</span><span class="p">[</span><span class="s">'brand'</span><span class="p">]</span> <span class="o">=</span> <span class="n">brandencoder</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">phones</span><span class="p">[</span><span class="s">'phone_brand'</span><span class="p">])</span>

<span class="c"># Combining with our row numbers</span>
<span class="n">sparse_encoding_brands</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">phones</span><span class="p">[[</span><span class="s">'device_id'</span><span class="p">,</span> <span class="s">'brand'</span><span class="p">]]</span>
    
    <span class="c"># Grab the rownum</span>
    <span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">gender_age_train</span><span class="p">[[</span><span class="s">'device_id'</span><span class="p">,</span><span class="s">'rownum'</span><span class="p">]],</span> <span class="n">how</span> <span class="o">=</span> <span class="s">'left'</span><span class="p">,</span> <span class="n">left_on</span> <span class="o">=</span> <span class="s">'device_id'</span><span class="p">,</span> <span class="n">right_on</span> <span class="o">=</span> <span class="s">'device_id'</span><span class="p">)</span>
    
    <span class="c"># Some devices are not in the training set</span>
    <span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
<span class="p">)</span>

<span class="c"># Building our sparse feature matrix</span>
<span class="n">sparse_brand_matrix</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">csr_matrix</span><span class="p">(</span>
        <span class="p">(</span>
            <span class="c"># We need as many 1s as there are</span>
            <span class="c"># rows in our training set</span>
            <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">sparse_encoding_brands</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> 
            
            <span class="c"># The rownum and app columns give</span>
            <span class="c"># us the indices at which to place</span>
            <span class="c"># the 1s</span>
            <span class="p">(</span>
                <span class="n">sparse_encoding_brands</span><span class="p">[</span><span class="s">'rownum'</span><span class="p">],</span> 
                <span class="n">sparse_encoding_brands</span><span class="p">[</span><span class="s">'brand'</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="p">)</span>
    <span class="p">)</span>
<span class="p">)</span>

<span class="c"># Let's plot the number of times a brand</span>
<span class="c"># occurs</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="nb">range</span><span class="p">(</span><span class="n">sparse_brand_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
    <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">sparse_brand_matrix</span><span class="o">.</span><span class="nb">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">flatten</span><span class="p">())[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
    <span class="n">label</span> <span class="o">=</span> <span class="s">'Number of phones by brand, sorted'</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span>
    <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">sparse_brand_matrix</span><span class="o">.</span><span class="nb">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">flatten</span><span class="p">())[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> 
    <span class="mi">0</span><span class="p">,</span>
    <span class="mf">0.8</span><span class="p">,</span>
    <span class="n">color</span> <span class="o">=</span> <span class="s">'black'</span><span class="p">,</span>
    <span class="n">label</span> <span class="o">=</span> <span class="s">'To the right of this line, no phones'</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre>
</div>

<p><img src="/pages/ClassifyMobileUsers_files/ClassifyMobileUsers_23_0.png" alt="png" /></p>

<p>Above, we’ve simply replicated the procedure we used for the apps to build a new sparse matrix. The plot shows the number of times the brands occur in the dataset, and we see again that many brands are not very prevalent, meaning these features are probably not very useful, and regularization is also important here.</p>

<p>We can now combine our new features with the app features and create a new classifier.</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="n">logreg_cv</span> <span class="o">=</span> <span class="n">LogisticRegressionCV</span><span class="p">(</span>
    <span class="n">Cs</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.075</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.125</span><span class="p">,</span> <span class="mf">0.15</span><span class="p">,</span> <span class="mf">0.175</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">],</span>
    <span class="n">penalty</span> <span class="o">=</span> <span class="s">'l2'</span><span class="p">,</span> 
    <span class="n">multi_class</span> <span class="o">=</span> <span class="s">'multinomial'</span><span class="p">,</span>
    <span class="n">solver</span> <span class="o">=</span> <span class="s">'lbfgs'</span><span class="p">,</span>
    <span class="n">max_iter</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span>
    <span class="n">cv</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
    <span class="n">n_jobs</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span>
    <span class="n">scoring</span> <span class="o">=</span> <span class="s">'neg_log_loss'</span>
<span class="p">)</span>
<span class="n">logreg_cv</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">hstack</span><span class="p">([</span><span class="n">sparse_app_matrix</span><span class="p">,</span> <span class="n">sparse_brand_matrix</span><span class="p">]),</span> <span class="n">target</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.075</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.125</span><span class="p">,</span> <span class="mf">0.15</span><span class="p">,</span> <span class="mf">0.175</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">],</span> <span class="o">-</span><span class="n">logreg_cv</span><span class="o">.</span><span class="n">scores_</span><span class="o">.</span><span class="n">popitem</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre>
</div>

<p><img src="/pages/ClassifyMobileUsers_files/ClassifyMobileUsers_25_0.png" alt="png" /></p>

<p>The optimal value for the regularization has shifted a little, but more importantly, our score has improved to about 2.355. What happens if we also add the phone models?</p>

<p>The models require a little bit of preprocessing, because different brands seem to use the same model names sometimes.</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="k">print</span><span class="p">(</span><span class="s">'Number of distinct model names: '</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">phones</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s">'device_model'</span><span class="p">])</span><span class="o">.</span><span class="n">size</span><span class="p">()</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
<span class="k">print</span><span class="p">(</span><span class="s">'Number of distinct brand+model names: '</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">phones</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s">'phone_brand'</span><span class="p">,</span><span class="s">'device_model'</span><span class="p">])</span><span class="o">.</span><span class="n">size</span><span class="p">()</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
</code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code>Number of distinct model names: 1599
Number of distinct brand+model names: 1667
</code></pre>
</div>

<p>That means we will have to combine the two columns into one, before building our features.</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="c"># Combine the two columns</span>
<span class="n">phones</span><span class="p">[</span><span class="s">'brand_and_model'</span><span class="p">]</span> <span class="o">=</span> <span class="n">phones</span><span class="p">[</span><span class="s">'phone_brand'</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span> <span class="o">+</span> <span class="n">phones</span><span class="p">[</span><span class="s">'device_model'</span><span class="p">]</span>

<span class="c"># Build numerical labels for our models</span>
<span class="n">modelencoder</span> <span class="o">=</span> <span class="n">LabelEncoder</span><span class="p">()</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">phones</span><span class="p">[</span><span class="s">'brand_and_model'</span><span class="p">])</span>

<span class="c"># Store in a new column</span>
<span class="n">phones</span><span class="p">[</span><span class="s">'model'</span><span class="p">]</span> <span class="o">=</span> <span class="n">modelencoder</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">phones</span><span class="p">[</span><span class="s">'brand_and_model'</span><span class="p">])</span>

<span class="c"># Combining with our row numbers</span>
<span class="n">sparse_encoding_models</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">phones</span><span class="p">[[</span><span class="s">'device_id'</span><span class="p">,</span> <span class="s">'model'</span><span class="p">]]</span>
    
    <span class="c"># Grab the rownum</span>
    <span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">gender_age_train</span><span class="p">[[</span><span class="s">'device_id'</span><span class="p">,</span><span class="s">'rownum'</span><span class="p">]],</span> <span class="n">how</span> <span class="o">=</span> <span class="s">'left'</span><span class="p">,</span> <span class="n">left_on</span> <span class="o">=</span> <span class="s">'device_id'</span><span class="p">,</span> <span class="n">right_on</span> <span class="o">=</span> <span class="s">'device_id'</span><span class="p">)</span>
    
    <span class="c"># Some devices are not in the training set</span>
    <span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
<span class="p">)</span>

<span class="c"># Building our sparse feature matrix</span>
<span class="n">sparse_model_matrix</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">csr_matrix</span><span class="p">(</span>
        <span class="p">(</span>
            <span class="c"># We need as many 1s as there are</span>
            <span class="c"># rows in our training set</span>
            <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">sparse_encoding_models</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> 
            
            <span class="c"># The rownum and app columns give</span>
            <span class="c"># us the indices at which to place</span>
            <span class="c"># the 1s</span>
            <span class="p">(</span>
                <span class="n">sparse_encoding_models</span><span class="p">[</span><span class="s">'rownum'</span><span class="p">],</span> 
                <span class="n">sparse_encoding_models</span><span class="p">[</span><span class="s">'model'</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="p">)</span>
    <span class="p">)</span>
<span class="p">)</span>

<span class="c"># Let's plot the number of times a brand</span>
<span class="c"># occurs</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="nb">range</span><span class="p">(</span><span class="n">sparse_model_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
    <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">sparse_model_matrix</span><span class="o">.</span><span class="nb">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">flatten</span><span class="p">())[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
    <span class="n">label</span> <span class="o">=</span> <span class="s">'Number of phones by model, sorted'</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span>
    <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">sparse_model_matrix</span><span class="o">.</span><span class="nb">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">flatten</span><span class="p">())[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> 
    <span class="mi">0</span><span class="p">,</span>
    <span class="mf">0.8</span><span class="p">,</span>
    <span class="n">color</span> <span class="o">=</span> <span class="s">'black'</span><span class="p">,</span>
    <span class="n">label</span> <span class="o">=</span> <span class="s">'To the right of this line, no phones'</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre>
</div>

<p><img src="/pages/ClassifyMobileUsers_files/ClassifyMobileUsers_29_0.png" alt="png" /></p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="n">logreg_cv</span> <span class="o">=</span> <span class="n">LogisticRegressionCV</span><span class="p">(</span>
    <span class="n">Cs</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.075</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.125</span><span class="p">,</span> <span class="mf">0.15</span><span class="p">,</span> <span class="mf">0.175</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">],</span>
    <span class="n">penalty</span> <span class="o">=</span> <span class="s">'l2'</span><span class="p">,</span> 
    <span class="n">multi_class</span> <span class="o">=</span> <span class="s">'multinomial'</span><span class="p">,</span>
    <span class="n">solver</span> <span class="o">=</span> <span class="s">'lbfgs'</span><span class="p">,</span>
    <span class="n">max_iter</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span>
    <span class="n">cv</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
    <span class="n">n_jobs</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span>
    <span class="n">scoring</span> <span class="o">=</span> <span class="s">'neg_log_loss'</span>
<span class="p">)</span>
<span class="n">logreg_cv</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">hstack</span><span class="p">([</span><span class="n">sparse_app_matrix</span><span class="p">,</span> <span class="n">sparse_brand_matrix</span><span class="p">,</span> <span class="n">sparse_model_matrix</span><span class="p">]),</span> <span class="n">target</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.075</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.125</span><span class="p">,</span> <span class="mf">0.15</span><span class="p">,</span> <span class="mf">0.175</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">],</span> <span class="o">-</span><span class="n">logreg_cv</span><span class="o">.</span><span class="n">scores_</span><span class="o">.</span><span class="n">popitem</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre>
</div>

<p><img src="/pages/ClassifyMobileUsers_files/ClassifyMobileUsers_30_0.png" alt="png" /></p>

<p>Adding the models has given us a small improvement, but not as substantial as the brands.</p>

<p>Now we’re ready to predict on the test set. We have to build sparse features for the test data as well, which works the same as before.</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="c"># Load in the data</span>
<span class="n">gender_age_test</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s">'input/gender_age_test.csv'</span><span class="p">)</span>
<span class="n">gender_age_test</span><span class="p">[</span><span class="s">'rownum'</span><span class="p">]</span> <span class="o">=</span> <span class="n">gender_age_test</span><span class="o">.</span><span class="n">index</span>

<span class="c"># Generate sparse feature matrices</span>

<span class="n">sparse_encoding_test_apps</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">device_apps</span><span class="p">[[</span><span class="s">'device_id'</span><span class="p">,</span> <span class="s">'app'</span><span class="p">]]</span>    
    <span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">gender_age_test</span><span class="p">[[</span><span class="s">'device_id'</span><span class="p">,</span><span class="s">'rownum'</span><span class="p">]],</span> <span class="n">how</span> <span class="o">=</span> <span class="s">'left'</span><span class="p">,</span> <span class="n">left_on</span> <span class="o">=</span> <span class="s">'device_id'</span><span class="p">,</span> <span class="n">right_on</span> <span class="o">=</span> <span class="s">'device_id'</span><span class="p">)</span>    
    <span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
<span class="p">)</span>

<span class="n">sparse_app_test_matrix</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">csr_matrix</span><span class="p">(</span>
        <span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">sparse_encoding_test_apps</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>             
            <span class="p">(</span>
                <span class="n">sparse_encoding_test_apps</span><span class="p">[</span><span class="s">'rownum'</span><span class="p">],</span> 
                <span class="n">sparse_encoding_test_apps</span><span class="p">[</span><span class="s">'app'</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="p">),</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">gender_age_test</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">appencoder</span><span class="o">.</span><span class="n">classes_</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
    <span class="p">)</span>
<span class="p">)</span>

<span class="n">sparse_encoding_test_brands</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">phones</span><span class="p">[[</span><span class="s">'device_id'</span><span class="p">,</span> <span class="s">'brand'</span><span class="p">]]</span>    
    <span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">gender_age_test</span><span class="p">[[</span><span class="s">'device_id'</span><span class="p">,</span><span class="s">'rownum'</span><span class="p">]],</span> <span class="n">how</span> <span class="o">=</span> <span class="s">'left'</span><span class="p">,</span> <span class="n">left_on</span> <span class="o">=</span> <span class="s">'device_id'</span><span class="p">,</span> <span class="n">right_on</span> <span class="o">=</span> <span class="s">'device_id'</span><span class="p">)</span>    
    <span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
<span class="p">)</span>

<span class="n">sparse_brand_test_matrix</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">csr_matrix</span><span class="p">(</span>
        <span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">sparse_encoding_test_brands</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>             
            <span class="p">(</span>
                <span class="n">sparse_encoding_test_brands</span><span class="p">[</span><span class="s">'rownum'</span><span class="p">],</span> 
                <span class="n">sparse_encoding_test_brands</span><span class="p">[</span><span class="s">'brand'</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="p">),</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">gender_age_test</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">brandencoder</span><span class="o">.</span><span class="n">classes_</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
    <span class="p">)</span>
<span class="p">)</span>

<span class="n">sparse_encoding_test_models</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">phones</span><span class="p">[[</span><span class="s">'device_id'</span><span class="p">,</span> <span class="s">'model'</span><span class="p">]]</span>    
    <span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">gender_age_test</span><span class="p">[[</span><span class="s">'device_id'</span><span class="p">,</span><span class="s">'rownum'</span><span class="p">]],</span> <span class="n">how</span> <span class="o">=</span> <span class="s">'left'</span><span class="p">,</span> <span class="n">left_on</span> <span class="o">=</span> <span class="s">'device_id'</span><span class="p">,</span> <span class="n">right_on</span> <span class="o">=</span> <span class="s">'device_id'</span><span class="p">)</span>    
    <span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
<span class="p">)</span>

<span class="n">sparse_model_test_matrix</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">csr_matrix</span><span class="p">(</span>
        <span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">sparse_encoding_test_models</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> 
            
            <span class="p">(</span>
                <span class="n">sparse_encoding_test_models</span><span class="p">[</span><span class="s">'rownum'</span><span class="p">],</span> 
                <span class="n">sparse_encoding_test_models</span><span class="p">[</span><span class="s">'model'</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="p">),</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">gender_age_test</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">modelencoder</span><span class="o">.</span><span class="n">classes_</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
    <span class="p">)</span>
<span class="p">)</span>

<span class="n">sparse_test_matrix</span> <span class="o">=</span> <span class="n">hstack</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="n">sparse_app_test_matrix</span><span class="p">,</span> 
        <span class="n">sparse_brand_test_matrix</span><span class="p">,</span> 
        <span class="n">sparse_model_test_matrix</span>
    <span class="p">]</span>
<span class="p">)</span>

<span class="n">sparse_train_matrix</span> <span class="o">=</span> <span class="n">hstack</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="n">sparse_app_matrix</span><span class="p">,</span> 
        <span class="n">sparse_brand_matrix</span><span class="p">,</span> 
        <span class="n">sparse_model_matrix</span>
    <span class="p">]</span>
<span class="p">)</span>

<span class="c"># Fit logistic regression</span>

<span class="n">logreg</span> <span class="o">=</span> <span class="n">LogisticRegression</span><span class="p">(</span>
    <span class="n">C</span> <span class="o">=</span> <span class="mf">0.15</span><span class="p">,</span>
    <span class="n">penalty</span> <span class="o">=</span> <span class="s">'l2'</span><span class="p">,</span> 
    <span class="n">multi_class</span> <span class="o">=</span> <span class="s">'multinomial'</span><span class="p">,</span>
    <span class="n">solver</span> <span class="o">=</span> <span class="s">'lbfgs'</span><span class="p">,</span>
    <span class="n">max_iter</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span>
    <span class="n">n_jobs</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">logreg</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
    <span class="n">sparse_train_matrix</span><span class="p">,</span> 
    <span class="n">target</span>
<span class="p">);</span>
</code></pre>
</div>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="c"># Generate prediction</span>
<span class="n">pred</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">logreg</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">sparse_test_matrix</span><span class="p">))</span>

<span class="c"># Rename the columns to the classes</span>
<span class="n">pred</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">logreg</span><span class="o">.</span><span class="n">classes_</span>

<span class="c"># Add device_id column</span>
<span class="n">pred</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">'device_id'</span><span class="p">,</span> <span class="n">gender_age_test</span><span class="p">[</span><span class="s">'device_id'</span><span class="p">])</span>

<span class="c"># Save</span>
<span class="n">pred</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s">'output/submission.csv'</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="bp">False</span><span class="p">)</span>
</code></pre>
</div>

<p>Above, we fitted the model on the training set, using the regularization coefficient we found through cross validation. The Kaggle competition was already closed at time of writing, but I generated a submission anyway, which scored 2.29; a reasonable score on the leaderboard for a relatively simple model!</p>

    </div>
</div>

          <div class="row">
            <div class="col-md-12 col-xs-12 footer">
              <footer>
  © 2017 Marco Tompitak - Powered by Jekyll.
</footer>

            </div>
          </div>
        </div> <!-- end /.col-md-9 -->
      </div> <!-- end /.row -->
    </div>

    
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
<script src="https://code.jquery.com/jquery-migrate-1.2.1.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>

<script src="/static/js/thickbox-compressed.js"></script>
<script src="/static/js/material.min.js"></script>
<script src="/static/js/main.js"></script>
<script src="/static/js/projects.js"></script>

    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-47199852-2', 'auto');
  ga('send', 'pageview');

</script>
  </body>
</html>
